<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة مجموعة البقالات - MAHMOUD HUSSEIN</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        * { font-family: 'Cairo', sans-serif; }
        :root {
            --primary: #006C35;
            --gold: #C5A059;
            --dark: #0a0a0a;
        }
        body {
            background: var(--dark);
            color: white;
            min-height: 100vh;
        }
        .glass {
            background: rgba(20, 20, 20, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .input-field {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            color: white;
            padding: 12px;
            border-radius: 10px;
            width: 100%;
        }
        .input-field:focus {
            outline: none;
            border-color: var(--gold);
        }
        .input-field option {
            background: #1a1a1a;
            color: white;
            padding: 10px;
        }
        select.input-field {
            background: rgba(30,30,30,0.95);
            color: #fff;
        }
        .btn-primary {
            background: var(--gold);
            color: black;
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            border: none;
        }
        .btn-primary:hover {
            background: #d4b068;
        }
        .page { display: none; }
        .page.active { display: block; }
        .nav-item.active {
            background: linear-gradient(90deg, var(--primary), transparent);
            border-right: 3px solid var(--gold);
        }
        .doc-thumb {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid rgba(255,255,255,0.2);
            cursor: pointer;
        }
        .doc-thumb:hover {
            transform: scale(3);
            z-index: 100;
            position: relative;
        }
        .platform-logo {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            background: white;
            padding: 6px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        .scroll-btns {
            position: fixed;
            bottom: 30px;
            left: 30px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .scroll-btns button {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(0,0,0,0.8);
            border: 2px solid var(--gold);
            color: var(--gold);
            cursor: pointer;
        }
        .scroll-btns button:hover {
            background: var(--gold);
            color: black;
        }
    </style>
</head>
<body>

    <!-- HEADER -->
    <header class="relative h-[400px] overflow-hidden border-b-2 border-yellow-600">
        <video autoplay loop muted playsinline class="absolute inset-0 w-full h-full object-cover object-[center_20%]">
            <source src="https://cms.saudiflag.sa/uploads/Untitled_video_Made_with_Clipchamp_4_720_1_674ecab38f.mp4" type="video/mp4">
        </video>
        <div class="absolute bottom-0 left-0 right-0 h-1/2 bg-gradient-to-t from-black to-transparent"></div>
        
        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/0/0d/Flag_of_Saudi_Arabia.svg/2560px-Flag_of_Saudi_Arabia.svg.png" 
             class="absolute top-4 left-4 w-40 rounded border-2 border-white/20 z-10">
        
        <div class="absolute bottom-0 left-0 right-0 bg-black/80 backdrop-blur-md p-4 flex justify-between items-center flex-wrap gap-4">
            <div>
                <h1 class="text-2xl font-black text-white">نظام إدارة مجموعة البقالات الموحد</h1>
                <p class="text-gold text-sm">الإصدار 2026 - تطوير MAHMOUD HUSSEIN</p>
            </div>
            <div class="flex items-center gap-4 bg-black/50 px-4 py-2 rounded-full">
                <div class="text-center">
                    <div id="clock" class="text-2xl font-mono font-bold text-yellow-500">00:00:00</div>
                </div>
                <div class="text-sm">
                    <div id="hijri" class="text-green-400"></div>
                    <div id="gregorian" class="text-gray-400"></div>
                </div>
            </div>
        </div>
    </header>

    <!-- MAIN LAYOUT -->
    <div class="flex">
        <!-- SIDEBAR -->
        <aside class="w-72 min-h-screen bg-black/90 border-l border-white/10 p-4 sticky top-0">
            <div class="glass rounded-xl p-4 mb-6">
                <div class="text-xs text-gray-400">المستخدم الحالي</div>
                <div class="flex items-center gap-2 mt-2">
                    <i class="fas fa-user-shield text-gold text-xl"></i>
                    <span class="font-bold">المدير العام</span>
                </div>
            </div>
            
            <nav class="space-y-2">
                <button onclick="showPage('dashboard')" class="nav-item active w-full p-4 rounded-xl flex items-center gap-3 text-gray-300 hover:bg-white/5">
                    <i class="fas fa-th-large text-xl"></i> لوحة القيادة
                </button>
                <button onclick="showPage('security')" class="nav-item w-full p-4 rounded-xl flex items-center gap-3 text-red-400 hover:bg-white/5">
                    <i class="fas fa-shield-virus text-xl"></i> الأمن السيبراني
                </button>
                <button onclick="showPage('branches')" class="nav-item w-full p-4 rounded-xl flex items-center gap-3 text-gray-300 hover:bg-white/5">
                    <i class="fas fa-store text-xl"></i> إدارة المنشآت
                </button>
                <button onclick="showPage('employees')" class="nav-item w-full p-4 rounded-xl flex items-center gap-3 text-gray-300 hover:bg-white/5">
                    <i class="fas fa-users text-xl"></i> إدارة الموظفين
                </button>
                <button onclick="showPage('alerts')" class="nav-item w-full p-4 rounded-xl flex items-center gap-3 text-yellow-400 hover:bg-white/5">
                    <i class="fas fa-bell text-xl"></i> التنبيهات
                </button>
                <button onclick="showPage('reports')" class="nav-item w-full p-4 rounded-xl flex items-center gap-3 text-gray-300 hover:bg-white/5">
                    <i class="fas fa-file-export text-xl"></i> التقارير والتصدير
                </button>
                <button onclick="showPage('settings')" class="nav-item w-full p-4 rounded-xl flex items-center gap-3 text-gray-300 hover:bg-white/5">
                    <i class="fas fa-cog text-xl"></i> الإعدادات
                </button>
            </nav>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="flex-1 p-6 overflow-y-auto" id="mainContent" style="max-height: calc(100vh - 400px);">
            
            <!-- DASHBOARD -->
            <div id="dashboard" class="page active space-y-6">
                <h2 class="text-3xl font-black">لوحة القيادة</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="glass p-6 rounded-2xl border-b-4 border-blue-500">
                        <div class="text-gray-400">الفروع</div>
                        <div class="text-4xl font-black" id="statBranches">0</div>
                    </div>
                    <div class="glass p-6 rounded-2xl border-b-4 border-purple-500">
                        <div class="text-gray-400">الموظفين</div>
                        <div class="text-4xl font-black" id="statEmployees">0</div>
                    </div>
                    <div class="glass p-6 rounded-2xl border-b-4 border-yellow-500 cursor-pointer" onclick="showPage('alerts')">
                        <div class="text-yellow-500">تنبيهات</div>
                        <div class="text-4xl font-black" id="statWarnings">0</div>
                    </div>
                    <div class="glass p-6 rounded-2xl border-b-4 border-red-500 cursor-pointer" onclick="showPage('alerts')">
                        <div class="text-red-500">منتهي</div>
                        <div class="text-4xl font-black" id="statExpired">0</div>
                    </div>
                </div>

                <div class="glass p-6 rounded-2xl">
                    <h3 class="text-xl font-bold mb-4">آخر التنبيهات</h3>
                    <div id="dashboardAlerts" class="space-y-2"></div>
                </div>
            </div>

            <!-- SECURITY -->
            <div id="security" class="page space-y-6">
                <div class="flex items-center gap-4 mb-6">
                    <div class="w-16 h-16 rounded-full bg-red-900/30 flex items-center justify-center border-2 border-red-500">
                        <i class="fas fa-shield-virus text-3xl text-red-500"></i>
                    </div>
                    <div>
                        <h2 class="text-3xl font-black">مركز الأمن السيبراني</h2>
                        <p class="text-gray-400">Cyber Defense Command Center</p>
                    </div>
                </div>

                <div class="grid grid-cols-4 gap-4">
                    <div class="glass p-4 rounded-xl border-l-4 border-green-500">
                        <div class="text-xs text-gray-400">Threat Level</div>
                        <div class="text-green-500 font-bold text-xl">LOW</div>
                    </div>
                    <div class="glass p-4 rounded-xl border-l-4 border-blue-500">
                        <div class="text-xs text-gray-400">Firewall</div>
                        <div class="text-blue-500 font-bold text-xl">ACTIVE</div>
                    </div>
                    <div class="glass p-4 rounded-xl border-l-4 border-purple-500">
                        <div class="text-xs text-gray-400">Encryption</div>
                        <div class="text-purple-500 font-bold text-xl">AES-256</div>
                    </div>
                    <div class="glass p-4 rounded-xl border-l-4 border-yellow-500">
                        <div class="text-xs text-gray-400">Last Scan</div>
                        <div class="text-yellow-500 font-bold text-xl" id="lastScan">--:--</div>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-6">
                    <div class="col-span-2 glass p-6 rounded-2xl">
                        <h4 class="text-sm text-gray-400 mb-4">Network Activity Monitor</h4>
                        <canvas id="securityChart" height="200"></canvas>
                    </div>
                    <div class="glass p-6 rounded-2xl">
                        <h4 class="text-sm text-gray-400 mb-4">Active Protection</h4>
                        <div class="space-y-3">
                            <div class="flex justify-between p-2 bg-white/5 rounded"><span>Anti-XSS</span><i class="fas fa-check-circle text-green-500"></i></div>
                            <div class="flex justify-between p-2 bg-white/5 rounded"><span>Anti-DDoS</span><i class="fas fa-check-circle text-green-500"></i></div>
                            <div class="flex justify-between p-2 bg-white/5 rounded"><span>MITM Protection</span><i class="fas fa-check-circle text-green-500"></i></div>
                            <div class="flex justify-between p-2 bg-white/5 rounded"><span>SQL Injection</span><i class="fas fa-check-circle text-green-500"></i></div>
                            <div class="flex justify-between p-2 bg-white/5 rounded"><span>File Tampering</span><i class="fas fa-check-circle text-green-500"></i></div>
                        </div>
                    </div>
                </div>

                <div class="glass p-6 rounded-2xl">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="text-sm text-gray-400">Security Terminal</h4>
                        <button onclick="runFullScan()" class="btn-primary text-sm">Full Scan</button>
                    </div>
                    <div id="secTerminal" class="bg-black rounded-xl p-4 font-mono text-xs text-green-500 h-48 overflow-y-auto">
                        <div>[SYSTEM] Security module initialized</div>
                        <div>[OK] All systems operational</div>
                    </div>
                </div>
            </div>

            <!-- BRANCHES -->
            <div id="branches" class="page space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-3xl font-black">إدارة المنشآت</h2>
                    <button onclick="openBranchModal()" class="btn-primary">
                        <i class="fas fa-plus ml-2"></i> إضافة منشأة
                    </button>
                </div>
                
                <input type="text" id="branchSearch" onkeyup="renderBranches()" placeholder="بحث..." class="input-field max-w-md">
                
                <div id="branchesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>

            <!-- EMPLOYEES -->
            <div id="employees" class="page space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-3xl font-black">إدارة الموظفين</h2>
                    <button onclick="openEmpModal()" class="btn-primary">
                        <i class="fas fa-plus ml-2"></i> إضافة موظف
                    </button>
                </div>
                
                <div class="flex gap-4">
                    <select id="empFilterBranch" onchange="renderEmployees()" class="input-field w-64">
                        <option value="">جميع الفروع</option>
                    </select>
                    <input type="text" id="empSearch" onkeyup="renderEmployees()" placeholder="بحث..." class="input-field flex-1">
                </div>
                
                <div class="glass rounded-2xl overflow-hidden">
                    <table class="w-full text-right">
                        <thead class="bg-white/5">
                            <tr>
                                <th class="p-4">الموظف</th>
                                <th class="p-4">الفرع</th>
                                <th class="p-4">الإقامة</th>
                                <th class="p-4">الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="empTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- ALERTS -->
            <div id="alerts" class="page space-y-6">
                <h2 class="text-3xl font-black text-red-500">
                    <i class="fas fa-exclamation-triangle ml-2"></i> غرفة التنبيهات
                </h2>
                
                <div class="glass rounded-2xl overflow-hidden">
                    <table class="w-full text-right">
                        <thead class="bg-white/5">
                            <tr>
                                <th class="p-4">البيان</th>
                                <th class="p-4">الوثيقة</th>
                                <th class="p-4">الحالة</th>
                                <th class="p-4">المنصة</th>
                                <th class="p-4">إجراء</th>
                            </tr>
                        </thead>
                        <tbody id="alertsTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- REPORTS -->
            <div id="reports" class="page space-y-6">
                <h2 class="text-3xl font-black">التقارير والتصدير</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <button onclick="exportExcel()" class="glass p-10 rounded-2xl text-center hover:bg-green-900/20 transition group">
                        <i class="fas fa-file-excel text-6xl text-green-500 mb-4 group-hover:scale-110 transition"></i>
                        <h3 class="text-2xl font-bold mb-2">تصدير Excel</h3>
                        <p class="text-gray-400">تحميل ملف شامل للفروع والموظفين</p>
                    </button>
                    
                    <button onclick="exportPDF()" class="glass p-10 rounded-2xl text-center hover:bg-red-900/20 transition group">
                        <i class="fas fa-file-pdf text-6xl text-red-500 mb-4 group-hover:scale-110 transition"></i>
                        <h3 class="text-2xl font-bold mb-2">تصدير PDF</h3>
                        <p class="text-gray-400">تقرير جاهز للطباعة</p>
                    </button>
                </div>
            </div>

            <!-- SETTINGS -->
            <div id="settings" class="page space-y-6">
                <h2 class="text-3xl font-black">الإعدادات</h2>
                
                <div class="glass p-6 rounded-2xl">
                    <h3 class="text-lg font-bold mb-4">إعدادات التنبيهات</h3>
                    <div class="flex items-center gap-4">
                        <label>التنبيه قبل الانتهاء بـ (أيام):</label>
                        <input type="number" id="alertDays" value="30" class="input-field w-32 text-center">
                    </div>
                </div>

                <div class="glass p-6 rounded-2xl border border-red-500/30">
                    <h3 class="text-red-500 font-bold mb-4">منطقة الخطر</h3>
                    <button onclick="factoryReset()" class="bg-red-500/20 text-red-500 border border-red-500/50 px-6 py-3 rounded-xl">
                        <i class="fas fa-trash ml-2"></i> حذف جميع البيانات
                    </button>
                </div>
            </div>

        </main>
    </div>

    <!-- SCROLL BUTTONS -->
    <div class="scroll-btns">
        <button onclick="document.getElementById('mainContent').scrollTo({top:0,behavior:'smooth'})" title="أعلى">
            <i class="fas fa-arrow-up"></i>
        </button>
        <button onclick="document.getElementById('mainContent').scrollTo({top:99999,behavior:'smooth'})" title="أسفل">
            <i class="fas fa-arrow-down"></i>
        </button>
    </div>

    <!-- FOOTER -->
    <footer class="bg-black border-t border-white/10 p-6 text-center">
        <div class="flex justify-center items-center gap-4 mb-4">
            <i class="fas fa-fingerprint text-3xl text-gold"></i>
            <div>
                <div class="font-bold">نظام إدارة البقالات الموحد</div>
                <div class="text-xs text-gray-500">Designed & Developed by <span class="text-gold font-bold">MAHMOUD HUSSEIN</span></div>
            </div>
        </div>
        <div class="bg-black/50 inline-block px-4 py-2 rounded-full border border-white/10 mb-3">
            <i class="fas fa-certificate text-blue-400 ml-2"></i>
            <span class="text-xs font-mono text-gray-300">© 2026 MAHMOUD HUSSEIN - All Rights Reserved</span>
        </div>
        <p class="text-xs text-gray-600 max-w-lg mx-auto">
            ⚠️ تحذير: يمنع نسخ أو بيع أو توزيع هذا النظام بدون إذن كتابي صريح من المالك MAHMOUD HUSSEIN
            <br>
            WARNING: Unauthorized copying or distribution is prohibited.
        </p>
    </footer>

    <!-- BRANCH MODAL -->
    <div id="branchModal" class="fixed inset-0 bg-black/90 z-50 hidden overflow-y-auto p-4">
        <div class="glass max-w-4xl mx-auto my-10 p-8 rounded-2xl">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gold">بيانات المنشأة</h3>
                <button onclick="closeBranchModal()" class="text-2xl">&times;</button>
            </div>
            <form onsubmit="saveBranch(event)" class="space-y-6">
                <input type="hidden" id="branchId">
                
                <!-- صورة المنشأة -->
                <div class="border-2 border-dashed border-gray-600 rounded-xl p-4 text-center">
                    <input type="file" id="branchImage" accept="image/*" onchange="previewImg(this,'branchPreview')" class="hidden">
                    <label for="branchImage" class="cursor-pointer">
                        <img id="branchPreview" class="w-full h-48 object-cover rounded-xl mb-2 hidden">
                        <div id="branchPlaceholder" class="text-gray-400">
                            <i class="fas fa-store text-4xl mb-2"></i>
                            <div>اضغط لرفع صورة المنشأة</div>
                        </div>
                    </label>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-sm text-gray-400">الفرع</label>
                        <select id="branchName" class="input-field" required></select>
                    </div>
                    <div>
                        <label class="text-sm text-gray-400">المؤسسة</label>
                        <select id="branchOrg" class="input-field" required></select>
                    </div>
                </div>

                <h4 class="text-lg font-bold text-green-400 border-b border-green-500/30 pb-2">المستندات الحكومية</h4>
                <div id="branchDocsContainer" class="space-y-4"></div>

                <button type="submit" class="w-full btn-primary py-4 text-lg">حفظ المنشأة</button>
            </form>
        </div>
    </div>

    <!-- EMPLOYEE MODAL -->
    <div id="empModal" class="fixed inset-0 bg-black/90 z-50 hidden overflow-y-auto p-4">
        <div class="glass max-w-4xl mx-auto my-10 p-8 rounded-2xl">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-blue-400">بيانات الموظف</h3>
                <button onclick="closeEmpModal()" class="text-2xl">&times;</button>
            </div>
            <form onsubmit="saveEmployee(event)" class="space-y-6">
                <input type="hidden" id="empId">
                
                <div class="flex gap-6">
                    <!-- صورة الموظف -->
                    <div class="w-40">
                        <div class="border-2 border-dashed border-gray-600 rounded-xl p-2 text-center aspect-[3/4]">
                            <input type="file" id="empImage" accept="image/*" onchange="previewImg(this,'empPreview')" class="hidden">
                            <label for="empImage" class="cursor-pointer h-full flex flex-col items-center justify-center">
                                <img id="empPreview" class="w-full h-full object-cover rounded-lg hidden">
                                <div id="empPlaceholder" class="text-gray-400">
                                    <i class="fas fa-camera text-3xl mb-2"></i>
                                    <div class="text-xs">صورة شخصية</div>
                                </div>
                            </label>
                        </div>
                    </div>

                    <div class="flex-1 grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-sm text-gray-400">الاسم الكامل</label>
                            <input type="text" id="empName" class="input-field" required>
                        </div>
                        <div>
                            <label class="text-sm text-gray-400">الجنسية</label>
                            <input type="text" id="empNat" class="input-field">
                        </div>
                        <div>
                            <label class="text-sm text-gray-400">الفرع</label>
                            <select id="empBranch" class="input-field" required>
                                <option value="">اختر الفرع</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-sm text-gray-400">المسؤول</label>
                            <select id="empResp" class="input-field">
                                <option value="">اختر</option>
                                <option>إنعام</option>
                                <option>رضوان</option>
                                <option>زكريا</option>
                                <option>شاجان</option>
                                <option>موهيت</option>
                                <option>نايف</option>
                                <option>نعيم</option>
                                <option>هلال</option>
                            </select>
                        </div>
                    </div>
                </div>

                <h4 class="text-lg font-bold text-blue-400 border-b border-blue-500/30 pb-2">المستندات</h4>
                <div id="empDocsContainer" class="space-y-4"></div>

                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl text-lg">حفظ الموظف</button>
            </form>
        </div>
    </div>

    <script>
        // CONFIG
        const DOCS_BRANCH = [
            {id: 'cr', name: 'السجل التجاري', platform: 'وزارة التجارة', url: 'https://mc.gov.sa', logo: 'https://www.google.com/s2/favicons?domain=mc.gov.sa&sz=64'},
            {id: 'mun', name: 'رخصة البلدية', platform: 'منصة بلدي', url: 'https://balady.gov.sa', logo: 'https://www.google.com/s2/favicons?domain=balady.gov.sa&sz=64'},
            {id: 'civ', name: 'الدفاع المدني', platform: 'منصة سلامة', url: 'https://salamah.998.gov.sa', logo: 'https://www.google.com/s2/favicons?domain=998.gov.sa&sz=64'},
            {id: 'zak', name: 'شهادة الزكاة', platform: 'هيئة الزكاة والضريبة', url: 'https://zatca.gov.sa', logo: 'https://www.google.com/s2/favicons?domain=zatca.gov.sa&sz=64'},
            {id: 'gcc', name: 'الغرفة التجارية', platform: 'اتحاد الغرف', url: 'https://csc.org.sa', logo: 'https://www.google.com/s2/favicons?domain=csc.org.sa&sz=64'},
            {id: 'gosi', name: 'التأمينات الاجتماعية', platform: 'التأمينات', url: 'https://www.gosi.gov.sa', logo: 'https://www.google.com/s2/favicons?domain=gosi.gov.sa&sz=64'}
        ];
        
        const DOCS_EMP = [
            {id: 'iqm', name: 'الإقامة', platform: 'منصة مقيم', url: 'https://muqeem.sa', logo: 'https://www.google.com/s2/favicons?domain=muqeem.sa&sz=64'},
            {id: 'wrk', name: 'رخصة العمل', platform: 'منصة قوى', url: 'https://qiwa.sa', logo: 'https://www.google.com/s2/favicons?domain=qiwa.sa&sz=64'},
            {id: 'ins', name: 'التأمين الطبي', platform: 'مجلس الضمان', url: 'https://cchi.gov.sa', logo: 'https://www.google.com/s2/favicons?domain=cchi.gov.sa&sz=64'},
            {id: 'abs', name: 'أبشر', platform: 'منصة أبشر', url: 'https://absher.sa', logo: 'https://www.google.com/s2/favicons?domain=absher.sa&sz=64'},
            {id: 'mdd', name: 'مدد', platform: 'منصة مدد', url: 'https://mudad.com.sa', logo: 'https://www.google.com/s2/favicons?domain=mudad.com.sa&sz=64'}
        ];
        
        const BRANCH_LIST = [
            "الرياض - الرئيسي", "جدة - الشمال", "جدة - الجنوب", "الدمام", "مكة المكرمة",
            "المدينة المنورة", "تبوك", "حائل", "جازان", "نجران", "أبها", "بريدة", "الطائف",
            "الواديين", "الخيرية", "العقبة"
        ];
        
        const ORG_LIST = [
            "تموينات أصل الباسل 1", "تموينات أصل الباسل 2", "داره المواسم 1", "داره المواسم 2",
            "مخابز ركن الفوارس 1", "مخابز ركن الفوارس 2", "درة الواديين", "إبريز الشرق",
            "ركن الفوارس وجبات", "الواديين بترومين", "الواديين بطحاء قريش", "الواديين الخيرية",
            "الواديين العقبة", "الواديين جامعة الملك خالد"
        ];

        let db = { branches: [], employees: [] };

        window.onload = function() {
            loadData();
            populateSelects();
            renderDocFields();
            updateClock();
            setInterval(updateClock, 1000);
            updateStats();
            initSecurityChart();
        };
        
        function populateSelects() {
            const branchSel = document.getElementById('branchName');
            branchSel.innerHTML = '<option value="">اختر الفرع</option>' + 
                BRANCH_LIST.map(b => `<option value="${b}">${b}</option>`).join('');
            
            const orgSel = document.getElementById('branchOrg');
            orgSel.innerHTML = '<option value="">اختر المؤسسة</option>' + 
                ORG_LIST.map(o => `<option value="${o}">${o}</option>`).join('');
        }

        function loadData() {
            const saved = localStorage.getItem('groceryDB_MH');
            if (saved) db = JSON.parse(saved);
        }

        function saveData() {
            localStorage.setItem('groceryDB_MH', JSON.stringify(db));
            updateStats();
        }

        function updateClock() {
            const now = new Date();
            document.getElementById('clock').textContent = now.toLocaleTimeString('en-US', {hour12: false});
            document.getElementById('gregorian').textContent = now.toLocaleDateString('en-GB');
            document.getElementById('hijri').textContent = new Intl.DateTimeFormat('ar-SA-u-ca-islamic', {
                day: 'numeric', month: 'long', year: 'numeric'
            }).format(now);
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(a => a.classList.remove('active'));
            event.target.closest('.nav-item')?.classList.add('active');

            if (pageId === 'branches') renderBranches();
            if (pageId === 'employees') renderEmployees();
            if (pageId === 'alerts') renderAlerts();
        }

        function updateStats() {
            document.getElementById('statBranches').textContent = db.branches.length;
            document.getElementById('statEmployees').textContent = db.employees.length;
            
            let warnings = 0, expired = 0;
            const alertDays = parseInt(document.getElementById('alertDays')?.value || 30);
            
            [...db.branches, ...db.employees].forEach(item => {
                Object.values(item.docs || {}).forEach(doc => {
                    if (doc.end) {
                        const days = Math.ceil((new Date(doc.end) - new Date()) / 86400000);
                        if (days < 0) expired++;
                        else if (days < alertDays) warnings++;
                    }
                });
            });
            
            document.getElementById('statWarnings').textContent = warnings;
            document.getElementById('statExpired').textContent = expired;

            const sel1 = document.getElementById('empBranch');
            const sel2 = document.getElementById('empFilterBranch');
            if (sel1) {
                sel1.innerHTML = '<option value="">اختر الفرع</option>' + 
                    BRANCH_LIST.map(b => `<option value="${b}">${b}</option>`).join('');
            }
            if (sel2) {
                sel2.innerHTML = '<option value="">جميع الفروع</option>' + 
                    BRANCH_LIST.map(b => `<option value="${b}">${b}</option>`).join('');
            }
        }

        function previewImg(input, previewId) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.getElementById(previewId);
                    img.src = e.target.result;
                    img.classList.remove('hidden');
                    img.nextElementSibling?.classList.add('hidden');
                    img.previousElementSibling?.classList.add('hidden');
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function renderDocFields() {
            document.getElementById('branchDocsContainer').innerHTML = DOCS_BRANCH.map(d => `
                <div class="glass p-4 rounded-xl">
                    <div class="flex items-center gap-4 mb-4">
                        <img src="${d.logo}" class="platform-logo" onerror="this.src='https://via.placeholder.com/40'">
                        <div class="flex-1">
                            <div class="font-bold">${d.name}</div>
                            <a href="${d.url}" target="_blank" class="text-xs text-blue-400 hover:underline">${d.platform} ↗</a>
                        </div>
                    </div>
                    <div class="grid grid-cols-4 gap-3">
                        <div>
                            <label class="text-xs text-gray-500">رقم المستند</label>
                            <input type="text" name="b_${d.id}_num" class="input-field text-sm" placeholder="رقم المستند">
                        </div>
                        <div>
                            <label class="text-xs text-gray-500">تاريخ الإصدار</label>
                            <input type="date" name="b_${d.id}_start" class="input-field text-sm">
                        </div>
                        <div>
                            <label class="text-xs text-red-400">تاريخ الانتهاء</label>
                            <input type="date" name="b_${d.id}_end" class="input-field text-sm border-red-500/30">
                        </div>
                        <div>
                            <label class="text-xs text-gray-500">صورة المستند</label>
                            <input type="file" name="b_${d.id}_img" accept="image/*" class="input-field text-sm p-1" onchange="previewDocImg(this, 'b_${d.id}_preview')">
                            <img id="b_${d.id}_preview" class="doc-thumb mt-2 hidden">
                        </div>
                    </div>
                </div>
            `).join('');

            document.getElementById('empDocsContainer').innerHTML = DOCS_EMP.map(d => `
                <div class="glass p-4 rounded-xl">
                    <div class="flex items-center gap-4 mb-4">
                        <img src="${d.logo}" class="platform-logo" onerror="this.src='https://via.placeholder.com/40'">
                        <div class="flex-1">
                            <div class="font-bold">${d.name}</div>
                            <a href="${d.url}" target="_blank" class="text-xs text-blue-400 hover:underline">${d.platform} ↗</a>
                        </div>
                    </div>
                    <div class="grid grid-cols-4 gap-3">
                        <div>
                            <label class="text-xs text-gray-500">رقم المستند</label>
                            <input type="text" name="e_${d.id}_num" class="input-field text-sm" placeholder="رقم المستند">
                        </div>
                        <div>
                            <label class="text-xs text-gray-500">تاريخ الإصدار</label>
                            <input type="date" name="e_${d.id}_start" class="input-field text-sm">
                        </div>
                        <div>
                            <label class="text-xs text-red-400">تاريخ الانتهاء</label>
                            <input type="date" name="e_${d.id}_end" class="input-field text-sm border-red-500/30">
                        </div>
                        <div>
                            <label class="text-xs text-gray-500">صورة المستند</label>
                            <input type="file" name="e_${d.id}_img" accept="image/*" class="input-field text-sm p-1" onchange="previewDocImg(this, 'e_${d.id}_preview')">
                            <img id="e_${d.id}_preview" class="doc-thumb mt-2 hidden">
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function previewDocImg(input, previewId) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.getElementById(previewId);
                    img.src = e.target.result;
                    img.classList.remove('hidden');
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function openBranchModal() { document.getElementById('branchModal').classList.remove('hidden'); }
        function closeBranchModal() { 
            document.getElementById('branchModal').classList.add('hidden');
            document.getElementById('branchId').value = '';
            document.getElementById('branchName').value = '';
            document.getElementById('branchOrg').value = '';
            document.getElementById('branchPreview').classList.add('hidden');
            document.getElementById('branchPlaceholder').classList.remove('hidden');
        }

        function saveBranch(e) {
            e.preventDefault();
            const id = document.getElementById('branchId').value || 'B' + Date.now();
            const docs = {};
            DOCS_BRANCH.forEach(d => {
                docs[d.id] = {
                    start: document.querySelector(`[name="b_${d.id}_start"]`).value,
                    end: document.querySelector(`[name="b_${d.id}_end"]`).value,
                    img: document.getElementById(`b_${d.id}_preview`)?.src || ''
                };
            });
            
            const branch = {
                id,
                name: document.getElementById('branchName').value,
                org: document.getElementById('branchOrg').value,
                image: document.getElementById('branchPreview').src || '',
                docs
            };
            
            const idx = db.branches.findIndex(b => b.id === id);
            if (idx > -1) db.branches[idx] = branch;
            else db.branches.push(branch);
            
            saveData();
            closeBranchModal();
            renderBranches();
        }

        function renderBranches() {
            const search = document.getElementById('branchSearch')?.value.toLowerCase() || '';
            const grid = document.getElementById('branchesGrid');
            
            grid.innerHTML = db.branches.filter(b => b.name.toLowerCase().includes(search)).map(b => `
                <div class="glass rounded-2xl overflow-hidden">
                    <div class="h-40 bg-cover bg-center relative" style="background-image: url('${b.image || ''}'); background-color: #1a1a1a;">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent"></div>
                        <div class="absolute bottom-4 right-4 left-4">
                            <h3 class="text-xl font-bold">${b.name}</h3>
                            <p class="text-xs text-gold">${b.org}</p>
                        </div>
                    </div>
                    <div class="p-4 space-y-2">
                        ${DOCS_BRANCH.map(d => {
                            const doc = b.docs[d.id];
                            if (!doc || !doc.end) return '';
                            const days = Math.ceil((new Date(doc.end) - new Date()) / 86400000);
                            const color = days < 0 ? 'text-red-500' : days < 30 ? 'text-yellow-500' : 'text-green-500';
                            return `
                                <div class="flex items-center gap-2 text-xs border-b border-white/5 pb-2">
                                    <img src="${d.logo}" class="w-6 h-6 rounded" onerror="this.src='https://via.placeholder.com/24'">
                                    <span class="flex-1">${d.name}</span>
                                    <span class="${color}">${doc.end}</span>
                                    ${doc.img ? `<img src="${doc.img}" class="doc-thumb w-8 h-8">` : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                    <div class="p-3 bg-white/5 flex justify-between">
                        <button onclick="editBranch('${b.id}')" class="text-blue-400"><i class="fas fa-edit"></i></button>
                        <button onclick="waBranch('${b.id}')" class="text-green-400"><i class="fab fa-whatsapp"></i></button>
                        <button onclick="deleteBranch('${b.id}')" class="text-red-400"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `).join('');
        }

        function editBranch(id) {
            const b = db.branches.find(x => x.id === id);
            if (!b) return;
            document.getElementById('branchId').value = b.id;
            document.getElementById('branchName').value = b.name;
            document.getElementById('branchOrg').value = b.org;
            if (b.image) {
                document.getElementById('branchPreview').src = b.image;
                document.getElementById('branchPreview').classList.remove('hidden');
                document.getElementById('branchPlaceholder').classList.add('hidden');
            }
            DOCS_BRANCH.forEach(d => {
                if (b.docs[d.id]) {
                    document.querySelector(`[name="b_${d.id}_start"]`).value = b.docs[d.id].start || '';
                    document.querySelector(`[name="b_${d.id}_end"]`).value = b.docs[d.id].end || '';
                    if (b.docs[d.id].img) {
                        document.getElementById(`b_${d.id}_preview`).src = b.docs[d.id].img;
                        document.getElementById(`b_${d.id}_preview`).classList.remove('hidden');
                    }
                }
            });
            openBranchModal();
        }

        function deleteBranch(id) {
            if (confirm('حذف هذا الفرع؟')) {
                db.branches = db.branches.filter(b => b.id !== id);
                saveData();
                renderBranches();
            }
        }

        function waBranch(id) {
            const b = db.branches.find(x => x.id === id);
            let msg = `*تقرير منشأة: ${b.name}*\n${b.org}\n\n`;
            DOCS_BRANCH.forEach(d => {
                if (b.docs[d.id]?.end) msg += `- ${d.name}: ${b.docs[d.id].end}\n  ${d.url}\n\n`;
            });
            window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
        }

        function openEmpModal() { 
            updateStats();
            document.getElementById('empModal').classList.remove('hidden'); 
        }
        function closeEmpModal() { 
            document.getElementById('empModal').classList.add('hidden');
            document.getElementById('empId').value = '';
            document.getElementById('empName').value = '';
            document.getElementById('empNat').value = '';
            document.getElementById('empBranch').value = '';
            document.getElementById('empResp').value = '';
            document.getElementById('empPreview').classList.add('hidden');
            document.getElementById('empPlaceholder').classList.remove('hidden');
        }

        function saveEmployee(e) {
            e.preventDefault();
            const id = document.getElementById('empId').value || 'E' + Date.now();
            const docs = {};
            DOCS_EMP.forEach(d => {
                docs[d.id] = {
                    start: document.querySelector(`[name="e_${d.id}_start"]`).value,
                    end: document.querySelector(`[name="e_${d.id}_end"]`).value,
                    img: document.getElementById(`e_${d.id}_preview`)?.src || ''
                };
            });
            
            const emp = {
                id,
                name: document.getElementById('empName').value,
                nat: document.getElementById('empNat').value,
                branchId: document.getElementById('empBranch').value,
                resp: document.getElementById('empResp').value,
                image: document.getElementById('empPreview').src || '',
                docs
            };
            
            const idx = db.employees.findIndex(x => x.id === id);
            if (idx > -1) db.employees[idx] = emp;
            else db.employees.push(emp);
            
            saveData();
            closeEmpModal();
            renderEmployees();
        }

        function renderEmployees() {
            const search = document.getElementById('empSearch')?.value.toLowerCase() || '';
            const filterBranch = document.getElementById('empFilterBranch')?.value || '';
            const tbody = document.getElementById('empTableBody');
            
            tbody.innerHTML = db.employees
                .filter(emp => emp.name.toLowerCase().includes(search) && (!filterBranch || emp.branchId === filterBranch))
                .map(emp => {
                    const branch = db.branches.find(b => b.id === emp.branchId);
                    const iqamaEnd = emp.docs?.iqm?.end;
                    let status = '-';
                    if (iqamaEnd) {
                        const days = Math.ceil((new Date(iqamaEnd) - new Date()) / 86400000);
                        if (days < 0) status = '<span class="text-red-500">منتهي</span>';
                        else if (days < 30) status = `<span class="text-yellow-500">${days} يوم</span>`;
                        else status = '<span class="text-green-500">ساري</span>';
                    }
                    
                    return `<tr class="border-b border-white/5 hover:bg-white/5">
                        <td class="p-4 flex items-center gap-3">
                            ${emp.image ? `<img src="${emp.image}" class="w-10 h-10 rounded-full object-cover">` : '<i class="fas fa-user text-2xl text-gray-500"></i>'}
                            <div>
                                <div class="font-bold">${emp.name}</div>
                                <div class="text-xs text-gray-500">${emp.nat || '-'}</div>
                            </div>
                        </td>
                        <td class="p-4 text-gray-300">${branch?.name || '-'}</td>
                        <td class="p-4">${status}</td>
                        <td class="p-4">
                            <button onclick="editEmployee('${emp.id}')" class="text-blue-400 ml-2"><i class="fas fa-edit"></i></button>
                            <button onclick="waEmployee('${emp.id}')" class="text-green-400 ml-2"><i class="fab fa-whatsapp"></i></button>
                            <button onclick="deleteEmployee('${emp.id}')" class="text-red-400"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`;
                }).join('');
        }

        function editEmployee(id) {
            const emp = db.employees.find(x => x.id === id);
            if (!emp) return;
            updateStats();
            document.getElementById('empId').value = emp.id;
            document.getElementById('empName').value = emp.name;
            document.getElementById('empNat').value = emp.nat;
            document.getElementById('empBranch').value = emp.branchId;
            document.getElementById('empResp').value = emp.resp;
            if (emp.image) {
                document.getElementById('empPreview').src = emp.image;
                document.getElementById('empPreview').classList.remove('hidden');
                document.getElementById('empPlaceholder').classList.add('hidden');
            }
            DOCS_EMP.forEach(d => {
                if (emp.docs[d.id]) {
                    document.querySelector(`[name="e_${d.id}_start"]`).value = emp.docs[d.id].start || '';
                    document.querySelector(`[name="e_${d.id}_end"]`).value = emp.docs[d.id].end || '';
                    if (emp.docs[d.id].img) {
                        document.getElementById(`e_${d.id}_preview`).src = emp.docs[d.id].img;
                        document.getElementById(`e_${d.id}_preview`).classList.remove('hidden');
                    }
                }
            });
            openEmpModal();
        }

        function deleteEmployee(id) {
            if (confirm('حذف هذا الموظف؟')) {
                db.employees = db.employees.filter(e => e.id !== id);
                saveData();
                renderEmployees();
            }
        }

        function waEmployee(id) {
            const emp = db.employees.find(x => x.id === id);
            let msg = `*ملف موظف: ${emp.name}*\n`;
            DOCS_EMP.forEach(d => {
                if (emp.docs[d.id]?.end) msg += `- ${d.name}: ${emp.docs[d.id].end}\n  ${d.url}\n\n`;
            });
            window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
        }

        function renderAlerts() {
            const tbody = document.getElementById('alertsTableBody');
            const alertDays = parseInt(document.getElementById('alertDays')?.value || 30);
            const rows = [];

            db.branches.forEach(b => {
                DOCS_BRANCH.forEach(d => {
                    if (b.docs[d.id]?.end) {
                        const days = Math.ceil((new Date(b.docs[d.id].end) - new Date()) / 86400000);
                        if (days < alertDays) {
                            rows.push({name: b.name, doc: d.name, end: b.docs[d.id].end, days, platform: d.platform, url: d.url, logo: d.logo});
                        }
                    }
                });
            });

            db.employees.forEach(emp => {
                DOCS_EMP.forEach(d => {
                    if (emp.docs[d.id]?.end) {
                        const days = Math.ceil((new Date(emp.docs[d.id].end) - new Date()) / 86400000);
                        if (days < alertDays) {
                            rows.push({name: emp.name, doc: d.name, end: emp.docs[d.id].end, days, platform: d.platform, url: d.url, logo: d.logo});
                        }
                    }
                });
            });

            rows.sort((a, b) => a.days - b.days);

            tbody.innerHTML = rows.length ? rows.map(r => `
                <tr class="border-b border-white/5 hover:bg-white/5">
                    <td class="p-4 font-bold">${r.name}</td>
                    <td class="p-4 text-gray-300">${r.doc}</td>
                    <td class="p-4 ${r.days < 0 ? 'text-red-500' : 'text-yellow-500'} font-bold">${r.days < 0 ? 'منتهي' : r.days + ' يوم'}</td>
                    <td class="p-4">
                        <div class="flex items-center gap-2">
                            <img src="${r.logo}" class="w-8 h-8 rounded bg-white p-1" onerror="this.src='https://via.placeholder.com/32'">
                            <span class="text-blue-300 text-sm">${r.platform}</span>
                        </div>
                    </td>
                    <td class="p-4">
                        <a href="${r.url}" target="_blank" class="btn-primary text-xs py-2 px-4">
                            <i class="fas fa-external-link-alt ml-1"></i> تجديد
                        </a>
                    </td>
                </tr>
            `).join('') : '<tr><td colspan="5" class="p-8 text-center text-gray-500">لا توجد تنبيهات</td></tr>';
        }

        let secChart;
        function initSecurityChart() {
            const ctx = document.getElementById('securityChart')?.getContext('2d');
            if (!ctx) return;
            
            secChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array(30).fill(''),
                    datasets: [{
                        label: 'Traffic',
                        data: Array(30).fill(0),
                        borderColor: '#00ff00',
                        backgroundColor: 'rgba(0, 255, 0, 0.1)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { x: { display: false }, y: { display: false, min: 0, max: 10 } }
                }
            });

            setInterval(() => {
                const data = secChart.data.datasets[0].data;
                data.shift();
                data.push(Math.random() * 3);
                secChart.update();
            }, 1000);
        }

        function runFullScan() {
            const terminal = document.getElementById('secTerminal');
            terminal.innerHTML = '';
            
            const steps = [
                '[INFO] Starting full system scan...',
                '[SCAN] Checking LocalStorage integrity...',
                '[OK] LocalStorage verified',
                '[SCAN] Analyzing network requests...',
                '[OK] No suspicious activity detected',
                '[SCAN] Checking XSS vulnerabilities...',
                '[OK] Input sanitization active',
                '[SCAN] Verifying encryption...',
                '[OK] AES-256 encryption confirmed',
                '[SUCCESS] System secure. No threats found.'
            ];

            steps.forEach((step, i) => {
                setTimeout(() => {
                    terminal.innerHTML += `<div class="${step.includes('SUCCESS') ? 'text-green-400 font-bold' : ''}">${step}</div>`;
                    terminal.scrollTop = terminal.scrollHeight;
                    
                    if (i === steps.length - 1) {
                        document.getElementById('lastScan').textContent = new Date().toLocaleTimeString('en-US', {hour12: false});
                    }
                }, i * 500);
            });
        }

        function exportExcel() {
            const wb = XLSX.utils.book_new();
            
            const bData = db.branches.map(b => {
                const row = {الفرع: b.name, المؤسسة: b.org};
                DOCS_BRANCH.forEach(d => {
                    row[d.name + ' - إصدار'] = b.docs[d.id]?.start || '';
                    row[d.name + ' - انتهاء'] = b.docs[d.id]?.end || '';
                });
                return row;
            });
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(bData), 'المنشآت');

            const eData = db.employees.map(emp => {
                const branch = db.branches.find(b => b.id === emp.branchId);
                const row = {الاسم: emp.name, الجنسية: emp.nat, الفرع: branch?.name, المسؤول: emp.resp};
                DOCS_EMP.forEach(d => {
                    row[d.name + ' - إصدار'] = emp.docs[d.id]?.start || '';
                    row[d.name + ' - انتهاء'] = emp.docs[d.id]?.end || '';
                });
                return row;
            });
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(eData), 'الموظفين');

            XLSX.writeFile(wb, 'Grocery_System_MH.xlsx');
        }

        function exportPDF() {
            window.print();
        }

        function factoryReset() {
            if (confirm('⚠️ سيتم حذف جميع البيانات نهائياً! متأكد؟')) {
                localStorage.removeItem('groceryDB_MH');
                location.reload();
            }
        }
    </script>
</body>
</html>
